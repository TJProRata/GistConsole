# Gist Console

A Next.js 16 application with Clerk authentication and Convex backend.

## Setup Instructions

### 1. Install Dependencies

```bash
bun install
```

### 2. Set Up Clerk Authentication

1. Create a Clerk account at https://clerk.com
2. Create a new application in the Clerk Dashboard
3. Copy your API keys from the **API Keys** page

### 3. Configure Environment Variables

Create or update `.env.local` with your Clerk keys:

```bash
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_DOMAIN=https://your-app.clerk.accounts.dev
CLERK_JWT_ISSUER_DOMAIN=https://your-app.clerk.accounts.dev

# Clerk Webhook (for automatic user sync)
CLERK_WEBHOOK_SECRET=whsec_...

# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:...
NEXT_PUBLIC_CONVEX_URL=https://....convex.cloud
```

**Note**: The `CLERK_JWT_ISSUER_DOMAIN` is required for Convex to validate Clerk JWT tokens. It should match your Clerk Frontend API URL (same as `CLERK_DOMAIN`). The `CLERK_WEBHOOK_SECRET` is required for automatic user synchronization. See the [Webhook Setup](#webhook-setup-optional-but-recommended) section below for configuration instructions.

### 4. Set Convex Environment Variable

**Important**: The `CLERK_JWT_ISSUER_DOMAIN` must also be configured in the Convex Dashboard:

1. Go to [Convex Dashboard → Environment Variables](https://dashboard.convex.dev)
2. Navigate to your project settings → Environment Variables
3. Click "Add Environment Variable"
4. Add:
   - **Name**: `CLERK_JWT_ISSUER_DOMAIN`
   - **Value**: `https://your-app.clerk.accounts.dev` (same as your `CLERK_DOMAIN`)
5. Click "Save"

This step is **required** for Clerk-Convex authentication to work properly.

### 5. Initialize Convex Project

Run the following command to create/link a Convex project:

```bash
npx convex dev
```

This will:
- Create a Convex project (or link to existing one)
- Generate Convex environment variables in `.env.local`
- Deploy the database schema (users table)
- Start the Convex development server
- Watch for changes in the `convex/` directory

### 6. Start the Next.js Development Server

In a **separate terminal**, run:

```bash
bun dev
```

Your app will be available at [http://localhost:3000](http://localhost:3000)

## Project Structure

```
/app
  /layout.tsx              # Root layout with ClerkProvider
  /ConvexClientProvider.tsx # Client-side Convex provider with Clerk integration
  /page.tsx                # Home page with sign in/up buttons
  /dashboard
    /page.tsx              # Protected dashboard page
  /globals.css             # Tailwind + shadcn CSS variables

/components
  /ui                      # shadcn components (button, card, input, label, form)
  /Header.tsx              # Header with Clerk authentication UI

/convex
  /schema.ts               # Database schema (users table)
  /auth.config.ts          # Clerk authentication configuration
  /users.ts                # User queries and helpers
  /_generated              # Auto-generated types (created by Convex)

/lib
  /utils.ts                # Utility functions (cn helper)

/middleware.ts             # Clerk authentication middleware (route protection)
```

## Features

- **Authentication**: Clerk authentication with pre-built UI components
- **Protected Routes**: Middleware-based route protection (automatic)
- **Real-time Database**: Convex backend with type-safe queries
- **User Management**: Automatic user sync from Clerk to Convex
- **Admin Portal**: Role-based access control with dedicated admin interface
- **shadcn/ui**: Beautiful, accessible UI components
- **TypeScript**: Full type safety throughout the application
- **Next.js 16 Compatible**: Works with latest Next.js async APIs

## Authentication Flow

1. **Sign Up**: Users click "Sign Up" button → Clerk modal opens → Create account
2. **Sign In**: Users click "Sign In" button → Clerk modal opens → Authenticate
3. **User Sync**: User data automatically synced to Convex database
4. **Dashboard**: Protected route accessible only when authenticated
5. **Sign Out**: Click UserButton (top right) → Sign out

## Architecture

```
User → Clerk (Auth UI) → JWT Token → Next.js App → Convex Database
              ↓                                         ↓
    ClerkProvider → ConvexProviderWithClerk → Authenticated Queries
```

**Key Components:**
- **Clerk**: Authentication provider (UI, sessions, JWTs)
- **Convex**: Database backend (users table, queries)
- **Middleware**: Automatic route protection (public vs protected)
- **ConvexProviderWithClerk**: Connects Clerk auth with Convex queries

## Tech Stack

- **Next.js 16**: React framework with App Router and Turbopack
- **React 19.2**: Latest React with modern hooks and patterns
- **Clerk**: Authentication and user management platform
- **Convex**: Backend-as-a-service with real-time database
- **shadcn/ui**: Component library built on Radix UI
- **Tailwind CSS**: Utility-first CSS framework
- **TypeScript 5.9.3**: Type-safe development
- **Bun 1.3.1**: Fast JavaScript runtime and package manager

## Development

### Run Convex Dev Server
```bash
npx convex dev
```

### Run Next.js Dev Server
```bash
bun dev
```

### Build for Production
```bash
bun run build
```

### Start Production Server
```bash
bun start
```

## Environment Variables

### Required (Clerk)

These must be manually added to `.env.local`:

- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`: Clerk publishable key (starts with `pk_test_` or `pk_live_`)
- `CLERK_SECRET_KEY`: Clerk secret key (starts with `sk_test_` or `sk_live_`)
- `CLERK_DOMAIN`: Your Clerk domain (e.g., `https://your-app.clerk.accounts.dev`)
- `CLERK_JWT_ISSUER_DOMAIN`: Your Clerk JWT issuer domain (same as `CLERK_DOMAIN`) - **Required for Convex authentication**

### Auto-Generated (Convex)

These are automatically created when you run `npx convex dev`:

- `CONVEX_DEPLOYMENT`: Your Convex deployment identifier
- `NEXT_PUBLIC_CONVEX_URL`: Public URL for Convex API

### Recommended (Webhooks)

- `CLERK_WEBHOOK_SECRET`: For automatic user sync via webhooks (see [Webhook Setup](#webhook-setup-optional-but-recommended) below)

## Webhook Setup (Optional but Recommended)

To ensure users are automatically synced to Convex when they sign up, configure Clerk webhooks:

### Local Development (using ngrok)

1. **Install ngrok** (if not already installed):
   ```bash
   brew install ngrok
   # or download from https://ngrok.com/download
   ```

2. **Start your development servers**:
   ```bash
   # Terminal 1: Convex
   npx convex dev

   # Terminal 2: Next.js
   bun dev

   # Terminal 3: ngrok tunnel
   ngrok http 3000
   ```

3. **Configure webhook in Clerk Dashboard**:
   - Copy the HTTPS URL from ngrok (e.g., `https://abc123.ngrok.io`)
   - Go to [Clerk Dashboard](https://dashboard.clerk.com) → Webhooks
   - Click "Add Endpoint"
   - Endpoint URL: `https://abc123.ngrok.io/api/webhook/clerk`
   - Subscribe to events: `user.created`, `user.updated`, `user.deleted`
   - Click "Create"
   - Copy the "Signing Secret" (starts with `whsec_`)

4. **Add webhook secret to `.env.local`**:
   ```bash
   CLERK_WEBHOOK_SECRET=whsec_your_secret_here
   ```

5. **Restart your Next.js server** to load the new environment variable

### Production Deployment

1. **Configure webhook in Clerk Dashboard**:
   - Go to [Clerk Dashboard](https://dashboard.clerk.com) → Webhooks
   - Click "Add Endpoint"
   - Endpoint URL: `https://your-domain.com/api/webhook/clerk`
   - Subscribe to events: `user.created`, `user.updated`, `user.deleted`
   - Copy the "Signing Secret"

2. **Add webhook secret to production environment**:
   - Add `CLERK_WEBHOOK_SECRET` to your production environment variables
   - Ensure HTTPS is enabled (required for webhooks)

### How It Works

- When a user signs up in Clerk, the webhook immediately creates their profile in Convex
- When a user updates their profile, the changes are synced to Convex
- Client-side sync (`useUserSync` hook) serves as a fallback for reliability

### Testing the Webhook

Test that webhooks are working:

1. Sign up with a new test account
2. Check Convex dashboard → Data → users table
3. User should appear immediately (without visiting dashboard)
4. View ngrok inspector at http://localhost:4040 to see webhook requests

## Protected Routes

Routes are automatically protected by the middleware. Configure public routes in `middleware.ts`:

```typescript
const isPublicRoute = createRouteMatcher([
  "/",               // Home page (public)
  "/sign-in(.*)",   // Clerk sign-in pages
  "/sign-up(.*)",   // Clerk sign-up pages
]);
```

All other routes require authentication.

## User Data Access

### In Client Components

```typescript
import { useUser } from "@clerk/nextjs";

const { user, isLoaded, isSignedIn } = useUser();
```

### In Convex Queries

```typescript
import { query } from "./_generated/server";
import { getCurrentUser } from "./users";

export const myQuery = query({
  handler: async (ctx) => {
    const user = await getCurrentUser(ctx);
    // user contains data from Convex users table
  },
});
```

## Admin Portal

### Overview

The admin portal provides role-based access control with a dedicated interface for managing users, configurations, analytics, and system settings. Only users with the `admin` role can access the admin portal.

### Features

- **User Management**: View all users, search/filter by name or email, view user roles
- **Configuration Management**: View all widget configurations across all users with search and category filtering
- **Component Library**: Browse and manage UI components (shadcn/ui) and widget components organized by category
- **Analytics Dashboard**: Platform usage trends and performance metrics (placeholder - coming soon)
- **System Settings**: Configure system-wide preferences (placeholder - coming soon)
- **Audit Logging**: All admin actions are logged to the `adminLogs` table for security tracking
- **Server-Side Authorization**: All admin queries enforce authorization at the database level

### Setting Up the First Admin User

**Important**: By default, all users are created with the `user` role. You must manually set the first admin user via the Convex Dashboard:

1. **Start your Convex dev server** (if not running):
   ```bash
   npx convex dev
   ```

2. **Sign in to your app** to create your user record in the database

3. **Open the Convex Dashboard**:
   - Go to [dashboard.convex.dev](https://dashboard.convex.dev)
   - Navigate to your project
   - Click on "Data" in the sidebar

4. **Find your user record**:
   - Click on the `users` table
   - Find your user by email or `clerkId`

5. **Set admin role**:
   - Click the "Edit" button (pencil icon) for your user record
   - Change the `role` field from `"user"` to `"admin"`
   - Click "Save"

6. **Refresh your app** - you should now see:
   - "Welcome Back Admin!" message on the home page
   - "Admin Portal" button below "Go to Dashboard"

### Admin Portal Access

**For Admin Users:**
- Home page shows "Welcome Back Admin!" instead of "Welcome Back!"
- "Admin Portal" button appears on the home page
- Direct access to `/admin` and all admin pages

**For Regular Users:**
- Home page shows standard "Welcome Back!" message
- No "Admin Portal" button visible
- Attempting to access `/admin` routes results in automatic redirect to `/dashboard`

### Admin Routes

- `/admin` - Admin dashboard with user and configuration statistics
- `/admin/users` - User management with search and filtering
- `/admin/configurations` - Configuration management with category filters
- `/admin/components` - Component library overview with statistics
- `/admin/components/ui-components` - Browse shadcn/ui components with search
- `/admin/components/widgets` - Browse widget components organized by category (icons, animations, AI elements, ask-anything)
- `/admin/analytics` - Analytics dashboard (placeholder)
- `/admin/settings` - System settings (placeholder)

### Security Considerations

1. **Server-Side Authorization**: All admin queries use the `requireAdmin()` helper which validates the user's role at the database level before executing any operation

2. **Client-Side Redirect**: Admin layout includes client-side authorization check with automatic redirect for non-admin users attempting to access admin routes

3. **Role Immutability**: User roles can only be changed via the Convex Dashboard - there is no UI for users to change their own roles or other users' roles

4. **Audit Trail**: All admin actions are logged to the `adminLogs` table with admin ID, action type, target user (if applicable), metadata, and timestamp

5. **Default Permissions**: All new users default to `"user"` role - admin role must be explicitly granted

### Testing the Admin Portal

1. Set your user role to `"admin"` in the Convex Dashboard (see setup steps above)
2. Sign in to your app
3. Verify "Welcome Back Admin!" message displays on home page
4. Click "Admin Portal" button
5. Verify admin dashboard loads with statistics
6. Test navigation to Users and Configurations pages
7. Test navigation to Components pages:
   - Click "Components" → "Overview" and verify statistics display
   - Click "UI Components" and verify table shows shadcn/ui components
   - Test search functionality on UI Components page
   - Click "Widgets" and verify tabs display for each category
   - Test search functionality across widget categories
8. Test search and filter functionality on all pages
9. Sign out and sign in as a regular user
10. Verify no "Admin Portal" button on home page
11. Manually navigate to `/admin` in browser
12. Verify automatic redirect to `/dashboard`

## Next Steps

- **Set up Clerk webhooks** (see [Webhook Setup](#webhook-setup-optional-but-recommended) above)
- **Set first admin user** (see [Admin Portal Setup](#setting-up-the-first-admin-user) above)
- Customize the dashboard page with widget configuration UI
- Implement analytics dashboard with real data
- Build the chat widget library
- Implement widget customization settings

## Documentation

- **Clerk Migration Guide**: See `ai_docs/clerkmigration.md` for complete Clerk + Convex integration details
- **Next.js 16 Docs**: See `ai_docs/next_js_docs/next_js_update.md`
- **React 19.2 Docs**: See `ai_docs/react_docs/react_update.md`
